<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç B√∫squeda de Aclaraciones - WEB2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .search-section {
            padding: 30px;
            border-bottom: 1px solid #eee;
        }

        .search-form {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        textarea {
            font-size: 14px;
            font-family: 'Courier New', monospace;
            resize: vertical;
            min-height: 120px;
        }

        input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }

        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-clear {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            padding: 30px;
            display: none;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results-count {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .results-table th {
            background: linear-gradient(45deg, #34495e, #2c3e50);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        .results-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        .id-badge {
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .cliente-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .comentarios {
            max-width: 300px;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .monto {
            font-weight: 600;
            color: #27ae60;
        }

        .fecha {
            color: #7f8c8d;
            font-size: 14px;
        }

        .sucursal {
            background: #ecf0f1;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            color: #34495e;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .no-results-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .error-message {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        @media (max-width: 768px) {
            .search-form {
                flex-direction: column;
            }
            
            .form-group {
                min-width: 100%;
            }
            
            .results-table {
                font-size: 14px;
            }
            
            .comentarios {
                max-width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç B√∫squeda de Aclaraciones</h1>
            <p>Busca aclaraciones por ID, cliente o comentarios</p>
        </div>

        <div class="search-section">
            <form class="search-form" id="searchForm">
                <div class="form-group">
                    <label for="searchType">üîç Tipo de B√∫squeda:</label>
                    <select id="searchType" onchange="toggleSearchMode()">
                        <option value="single">B√∫squeda Individual</option>
                        <option value="multiple-ids">B√∫squeda Masiva (IDs/Transacciones)</option>
                        <option value="multiple-auth">B√∫squeda Masiva (Autorizaciones)</option>
                        <option value="cascada-excel">üéØ B√∫squeda Inteligente (Cascada Excel)</option>
                    </select>
                </div>
                
                <div class="form-group" id="singleSearchGroup">
                    <label for="searchId">üÜî ID de Transacci√≥n:</label>
                    <input type="text" id="searchId" placeholder="Ej: 202908">
                    <small style="color: #666; font-size: 12px;">üí° Usar el ID de transacci√≥n, no el ID interno de la base de datos</small>
                </div>
                
                <div class="form-group" id="multipleIdsGroup" style="display: none;">
                    <label for="searchIds">üìù IDs de Transacci√≥n M√∫ltiples:</label>
                    <textarea id="searchIds" placeholder="Ejemplo:&#10;202908&#10;205797&#10;96756&#10;...&#10;&#10;Pega aqu√≠ tus IDs de transacci√≥n, uno por l√≠nea" rows="8"></textarea>
                    <small style="color: #666; font-size: 12px;">üí° Puedes pegar todos los IDs que necesites. Sep√°ralos por l√≠neas, comas o espacios.</small>
                </div>
                
                <div class="form-group" id="multipleAuthGroup" style="display: none;">
                    <label for="searchAuths">üîë Autorizaciones M√∫ltiples:</label>
                    <textarea id="searchAuths" placeholder="Ejemplo:&#10;AUTH123456&#10;AUTH789012&#10;AUTH345678&#10;...&#10;&#10;Pega aqu√≠ tus n√∫meros de autorizaci√≥n, uno por l√≠nea" rows="8"></textarea>
                    <small style="color: #666; font-size: 12px;">üí° Busca en campo: autorizacion. Sin l√≠mite de cantidad.</small>
                </div>
                
                <div class="form-group" id="cascadaExcelGroup" style="display: none; width: 100%;">
                    <label for="excelData">üìä Datos de Excel (4 columnas):</label>
                    <textarea id="excelData" placeholder="Pega aqu√≠ los datos de tu Excel con este formato:&#10;ID&#9;FOLIO&#9;REFERENCIA&#9;AUTORIZACION&#10;123&#9;ABC456&#9;REF789&#9;AUTH012&#10;456&#9;DEF789&#9;REF123&#9;AUTH345&#10;...&#10;&#10;üí° Separa las columnas con TAB (como cuando copias de Excel)&#10;üîç Todos los campos se buscan en id_de_transaccion" rows="10" style="font-family: 'Courier New', monospace; font-size: 12px;"></textarea>
                    <small style="color: #666; font-size: 12px;">üí° <strong>B√∫squeda en Cascada:</strong> Busca por ID ‚Üí Folio ‚Üí Referencia ‚Üí Autorizaci√≥n (todos en campo id_de_transaccion) hasta encontrar cada registro.</small>
                    <div id="cascadaStats" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; display: none;">
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center;">
                            <div><strong>üìä Total:</strong> <span id="totalRows">0</span></div>
                            <div><strong>‚úÖ ID:</strong> <span id="validIds">0</span></div>
                            <div><strong>üìù Folio:</strong> <span id="validFolios">0</span></div>
                            <div><strong>üîë Auth:</strong> <span id="validAuths">0</span></div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="searchCliente">üë§ Cliente:</label>
                    <input type="text" id="searchCliente" placeholder="Nombre del cliente">
                </div>
                
                <div class="form-group">
                    <label for="searchComentarios">üí¨ Comentarios:</label>
                    <input type="text" id="searchComentarios" placeholder="Buscar en comentarios">
                </div>
                
                <div class="form-group">
                    <label for="searchSucursal">üè¢ Sucursal:</label>
                    <select id="searchSucursal">
                        <option value="">Todas las sucursales</option>
                        <option value="ALEGRA BARRANQUILLA">ALEGRA BARRANQUILLA</option>
                        <option value="PLAZA LAS MISIONES">PLAZA LAS MISIONES</option>
                        <option value="SENDERO ESCOBEDO">SENDERO ESCOBEDO</option>
                        <option value="PLAZA FIESTA SAN AGUSTIN">PLAZA FIESTA SAN AGUSTIN</option>
                    </select>
                </div>
                
                <button type="submit" class="btn">
                    üîç Buscar
                </button>
                
                <button type="button" class="btn btn-clear" onclick="clearForm()">
                    üóëÔ∏è Limpiar
                </button>
                
                <button type="button" class="btn" id="exportBtn" onclick="exportarResultados()" style="display: none; background: linear-gradient(45deg, #27ae60, #2ecc71);">
                    üìä Exportar Excel
                </button>
            </form>
        </div>

        <div class="error-message" id="errorMessage">
        </div>

        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>Buscando aclaraciones...</p>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <div class="results-count" id="resultsCount">
                    0 resultados encontrados
                </div>
            </div>
            
            <table class="results-table" id="resultsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ID Transacci√≥n</th>
                        <th>Autorizaci√≥n</th>
                        <th>Cliente</th>
                        <th>Sucursal</th>
                        <th>Monto</th>
                        <th>Fecha Petici√≥n</th>
                        <th>Comentarios</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                </tbody>
            </table>

            <div class="no-results" id="noResults" style="display: none;">
                <div class="no-results-icon">üîç</div>
                <h3>No se encontraron resultados</h3>
                <p>Intenta con otros t√©rminos de b√∫squeda</p>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n de la API
        const API_BASE_URL = 'http://localhost:3001';

        // Referencias DOM
        const searchForm = document.getElementById('searchForm');
        const loadingDiv = document.getElementById('loading');
        const resultsSection = document.getElementById('resultsSection');
        const resultsCount = document.getElementById('resultsCount');
        const resultsBody = document.getElementById('resultsBody');
        const noResults = document.getElementById('noResults');
        const errorMessage = document.getElementById('errorMessage');

        // Manejar env√≠o del formulario
        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await realizarBusqueda();
        });

        // Funci√≥n principal de b√∫squeda
        async function realizarBusqueda() {
            try {
                mostrarCargando(true);
                ocultarError();

                const searchType = document.getElementById('searchType').value;
                let response;
                
                if (searchType === 'multiple-ids' || searchType === 'multiple-auth') {
                    // Para b√∫squedas masivas, usar POST para evitar URLs demasiado largas
                    const bodyData = construirBodyBusquedaMasiva();
                    console.log('üîç Realizando b√∫squeda masiva POST:', bodyData);
                    
                    response = await fetch(`${API_BASE_URL}/api/data/aclaraciones`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(bodyData)
                    });
                } else {
                    // Para b√∫squeda individual, mantener GET
                    const params = construirParametrosBusqueda();
                    const url = `${API_BASE_URL}/api/data/aclaraciones?${params}`;
                    console.log('üîç Realizando b√∫squeda individual GET:', url);
                    response = await fetch(url);
                }
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                mostrarResultados(data.data || [], data.query || {}, data);
                
            } catch (error) {
                console.error('‚ùå Error en la b√∫squeda:', error);
                mostrarError(`Error al realizar la b√∫squeda: ${error.message}`);
            } finally {
                mostrarCargando(false);
            }
        }

        // Construir par√°metros de b√∫squeda
        function construirParametrosBusqueda() {
            const searchType = document.getElementById('searchType').value;
            
            if (searchType === 'multiple-ids') {
                return construirBusquedaMultipleIds();
            } else if (searchType === 'multiple-auth') {
                return construirBusquedaMultipleAuth();
            } else {
                return construirBusquedaIndividual();
            }
        }

        // B√∫squeda individual (original)
        function construirBusquedaIndividual() {
            const params = new URLSearchParams();
            
            const id = document.getElementById('searchId').value.trim();
            const cliente = document.getElementById('searchCliente').value.trim();
            const comentarios = document.getElementById('searchComentarios').value.trim();
            const sucursal = document.getElementById('searchSucursal').value.trim();

            if (id) {
                params.append('id_de_transaccion', id);
            }
            
            if (cliente) {
                params.append('cliente', cliente);
            }
            
            if (comentarios) {
                params.append('comentarios', comentarios);
            }
            
            if (sucursal) {
                params.append('sucursal', sucursal);
            }

            // L√≠mite de resultados para evitar sobrecarga
            params.append('limit', '100');
            
            return params.toString();
        }

        // B√∫squeda m√∫ltiple IDs/Transacciones
        function construirBusquedaMultipleIds() {
            const idsText = document.getElementById('searchIds').value.trim();
            
            if (!idsText) {
                throw new Error('Por favor ingresa al menos un ID de transacci√≥n para buscar');
            }

            // Extraer IDs del texto usando m√∫ltiples separadores
            const ids = idsText
                .split(/[\n,\s]+/)  // Separar por l√≠neas, comas o espacios
                .map(id => id.trim())
                .filter(id => id);  // Solo valores no vac√≠os

            if (ids.length === 0) {
                throw new Error('No se encontraron IDs v√°lidos para buscar.');
            }

            console.log(`üìä Procesando ${ids.length} IDs de transacci√≥n para b√∫squeda masiva`);

            const params = new URLSearchParams();
            params.append('id_de_transaccion_multiple', ids.join(','));  // Nuevo par√°metro
            params.append('limit', '50000');  // L√≠mite alto para b√∫squeda masiva
            
            return params.toString();
        }

        // B√∫squeda m√∫ltiple por Autorizaciones (nueva)
        function construirBusquedaMultipleAuth() {
            const authsText = document.getElementById('searchAuths').value.trim();
            
            if (!authsText) {
                throw new Error('Por favor ingresa al menos un n√∫mero de autorizaci√≥n para buscar');
            }

            // Extraer autorizaciones del texto
            const auths = authsText
                .split(/[\n,\s]+/)  // Separar por l√≠neas, comas o espacios
                .map(auth => auth.trim())
                .filter(auth => auth);  // Solo valores no vac√≠os

            if (auths.length === 0) {
                throw new Error('No se encontraron autorizaciones v√°lidas para buscar.');
            }

            console.log(`üîë Procesando ${auths.length} n√∫meros de autorizaci√≥n para b√∫squeda masiva`);

            const params = new URLSearchParams();
            params.append('autorizacion_multiple', auths.join(','));  // Nuevo par√°metro
            params.append('limit', '50000');  // L√≠mite alto para b√∫squeda masiva
            
            return params.toString();
        }

        // Construir body para b√∫squedas masivas (POST)
        function construirBodyBusquedaMasiva() {
            const searchType = document.getElementById('searchType').value;
            
            if (searchType === 'multiple-ids') {
                const idsText = document.getElementById('searchIds').value.trim();
                
                if (!idsText) {
                    throw new Error('Por favor ingresa al menos un ID de transacci√≥n para buscar');
                }

                const ids = idsText
                    .split(/[\n,\s]+/)
                    .map(id => id.trim())
                    .filter(id => id);

                if (ids.length === 0) {
                    throw new Error('No se encontraron IDs v√°lidos para buscar.');
                }

                return {
                    searchType: 'bulk_ids',
                    ids: ids,
                    limit: 50000
                };
                
            } else if (searchType === 'multiple-auth') {
                const authsText = document.getElementById('searchAuths').value.trim();
                
                if (!authsText) {
                    throw new Error('Por favor ingresa al menos un n√∫mero de autorizaci√≥n para buscar');
                }

                const auths = authsText
                    .split(/[\n,\s]+/)
                    .map(auth => auth.trim())
                    .filter(auth => auth);

                if (auths.length === 0) {
                    throw new Error('No se encontraron autorizaciones v√°lidas para buscar.');
                }

                return {
                    searchType: 'bulk_auth',
                    autorizaciones: auths,
                    limit: 50000
                };
                
            } else if (searchType === 'cascada-excel') {
                const excelData = document.getElementById('excelData').value.trim();
                
                if (!excelData) {
                    throw new Error('Por favor pega los datos de Excel con las 4 columnas (ID, FOLIO, REFERENCIA, AUTORIZACION)');
                }

                const rows = parseExcelData(excelData);
                
                if (rows.length === 0) {
                    throw new Error('No se encontraron filas v√°lidas en los datos de Excel');
                }

                return {
                    searchType: 'cascada_excel',
                    excelRows: rows,
                    limit: 50000
                };
            }
        }

        // Parsear datos de Excel (4 columnas)
        function parseExcelData(excelText) {
            const lines = excelText.split('\n').map(line => line.trim()).filter(line => line);
            const rows = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // Intentar separar por tabs primero, luego por comas
                let columns = line.split('\t');
                if (columns.length < 4) {
                    columns = line.split(',').map(col => col.trim());
                }
                
                // Si a√∫n no tiene 4 columnas, intentar separar por espacios m√∫ltiples
                if (columns.length < 4) {
                    columns = line.split(/\s{2,}/).map(col => col.trim());
                }
                
                // Validar que tenga al menos las 4 columnas
                if (columns.length >= 4) {
                    const [id, folio, referencia, autorizacion] = columns;
                    
                    // Al menos uno de los campos debe tener contenido
                    if (id || folio || referencia || autorizacion) {
                        rows.push({
                            originalRow: i + 1,
                            id: (id || '').trim(),
                            folio: (folio || '').trim(), 
                            referencia: (referencia || '').trim(),
                            autorizacion: (autorizacion || '').trim()
                        });
                    }
                }
            }
            
            return rows; // Sin l√≠mite de filas
        }

        // Mostrar resultados en la tabla
        function mostrarResultados(resultados, queryInfo = {}, responseData = {}) {
            resultsBody.innerHTML = '';
            
            if (resultados.length === 0) {
                resultsSection.style.display = 'block';
                noResults.style.display = 'block';
                document.getElementById('resultsTable').style.display = 'none';
                resultsCount.textContent = '0 resultados encontrados';
                return;
            }

            noResults.style.display = 'none';
            document.getElementById('resultsTable').style.display = 'table';
            resultsSection.style.display = 'block';
            
            // Determinar tipo de b√∫squeda
            const isCascadaExcel = responseData.searchType === 'cascada_excel';
            
            // Mostrar informaci√≥n seg√∫n el tipo de b√∫squeda
            let countText = `${resultados.length} resultado${resultados.length !== 1 ? 's' : ''} encontrado${resultados.length !== 1 ? 's' : ''}`;
            
            if (isCascadaExcel && responseData.cascadaStats) {
                const stats = responseData.cascadaStats;
                countText = `üéØ B√∫squeda en Cascada: ${resultados.length}/${stats.totalRows} encontrados`;
                countText += ` (ID: ${stats.encontradosPorId}, Folio: ${stats.encontradosPorFolio}, Ref: ${stats.encontradosPorReferencia}, Auth: ${stats.encontradosPorAutorizacion})`;
            } else if (queryInfo.ids && queryInfo.totalRequested) {
                countText += ` de ${queryInfo.totalRequested} IDs solicitados`;
                
                if (queryInfo.notFound && queryInfo.notFound.length > 0) {
                    countText += ` (${queryInfo.notFound.length} no encontrados)`;
                }
            }
            
            resultsCount.innerHTML = countText;

            resultados.forEach(aclaracion => {
                const row = document.createElement('tr');
                
                // Informaci√≥n adicional para b√∫squeda en cascada
                let foundByInfo = '';
                if (aclaracion.foundBy && aclaracion.foundWith) {
                    const colorMap = {
                        'id': '#3498db',
                        'folio': '#e67e22', 
                        'referencia': '#9b59b6',
                        'autorizacion': '#27ae60'
                    };
                    foundByInfo = `<div style="font-size: 11px; color: ${colorMap[aclaracion.foundBy] || '#666'};">
                        üìç ${aclaracion.foundBy.toUpperCase()}: ${aclaracion.foundWith}
                    </div>`;
                }
                
                // Determinar color del comentario
                let comentarioTexto = aclaracion.comentarios || 'Sin comentarios';
                let comentarioColor = '';
                
                // Si contiene "revision manual requerida", ponerlo en rojo
                if (comentarioTexto.toLowerCase().includes('revision manual requerida')) {
                    comentarioColor = 'color: #e74c3c; font-weight: bold; background: #ffeaa7; padding: 2px 6px; border-radius: 4px;';
                }
                
                row.innerHTML = `
                    <td>
                        <span class="id-badge">${aclaracion.id || '-'}</span>
                        ${foundByInfo}
                    </td>
                    <td><div class="cliente-name">${aclaracion.id_de_transaccion || '-'}</div></td>
                    <td><div style="font-family: monospace; color: #e67e22;">${aclaracion.autorizacion || '-'}</div></td>
                    <td><div class="cliente-name">${aclaracion.cliente || 'Sin cliente'}</div></td>
                    <td><span class="sucursal">${aclaracion.sucursal || 'Sin sucursal'}</span></td>
                    <td><div class="monto">${formatearMonto(aclaracion.monto)}</div></td>
                    <td><div class="fecha">${formatearFecha(aclaracion.fecha_de_peticion)}</div></td>
                    <td><div class="comentarios" style="${comentarioColor}">${comentarioTexto}</div></td>
                `;
                resultsBody.appendChild(row);
            });

            // Mostrar elementos no encontrados
            if (isCascadaExcel && responseData.notFound && responseData.notFound.length > 0) {
                mostrarRegistrosNoEncontradosCascada(responseData.notFound);
            } else if (queryInfo.notFound && queryInfo.notFound.length > 0) {
                mostrarIdsNoEncontrados(queryInfo.notFound);
            }

            // Mostrar bot√≥n de exportar si hay resultados
            document.getElementById('exportBtn').style.display = resultados.length > 0 ? 'flex' : 'none';
            
            // Guardar resultados para exportar
            window.ultimosResultados = resultados;
            window.ultimaRespuesta = responseData;
        }

        // Formatear monto
        function formatearMonto(monto) {
            if (!monto) return '-';
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            }).format(monto);
        }

        // Formatear fecha
        function formatearFecha(fecha) {
            if (!fecha) return '-';
            try {
                return new Date(fecha).toLocaleDateString('es-MX', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            } catch {
                return fecha;
            }
        }

        // Mostrar/ocultar indicador de carga
        function mostrarCargando(mostrar) {
            loadingDiv.style.display = mostrar ? 'block' : 'none';
            if (mostrar) {
                resultsSection.style.display = 'none';
            }
        }

        // Mostrar error
        function mostrarError(mensaje) {
            errorMessage.textContent = mensaje;
            errorMessage.style.display = 'block';
            resultsSection.style.display = 'none';
        }

        // Ocultar error
        function ocultarError() {
            errorMessage.style.display = 'none';
        }

        // Cambiar modo de b√∫squeda
        function toggleSearchMode() {
            const searchType = document.getElementById('searchType').value;
            const singleGroup = document.getElementById('singleSearchGroup');
            const multipleIdsGroup = document.getElementById('multipleIdsGroup');
            const multipleAuthGroup = document.getElementById('multipleAuthGroup');
            const cascadaExcelGroup = document.getElementById('cascadaExcelGroup');
            
            // Ocultar todos los grupos primero
            singleGroup.style.display = 'none';
            multipleIdsGroup.style.display = 'none';
            multipleAuthGroup.style.display = 'none';
            cascadaExcelGroup.style.display = 'none';
            
            // Mostrar el grupo correspondiente
            if (searchType === 'multiple-ids') {
                multipleIdsGroup.style.display = 'block';
                // Desactivar otros campos para b√∫squeda masiva de IDs
                document.getElementById('searchCliente').disabled = true;
                document.getElementById('searchComentarios').disabled = true;
                document.getElementById('searchSucursal').disabled = true;
            } else if (searchType === 'multiple-auth') {
                multipleAuthGroup.style.display = 'block';
                // Desactivar otros campos para b√∫squeda masiva de autorizaciones
                document.getElementById('searchCliente').disabled = true;
                document.getElementById('searchComentarios').disabled = true;
                document.getElementById('searchSucursal').disabled = true;
            } else if (searchType === 'cascada-excel') {
                cascadaExcelGroup.style.display = 'block';
                // Desactivar otros campos para b√∫squeda en cascada
                document.getElementById('searchCliente').disabled = true;
                document.getElementById('searchComentarios').disabled = true;
                document.getElementById('searchSucursal').disabled = true;
            } else {
                singleGroup.style.display = 'block';
                // Reactivar otros campos para b√∫squeda individual
                document.getElementById('searchCliente').disabled = false;
                document.getElementById('searchComentarios').disabled = false;
                document.getElementById('searchSucursal').disabled = false;
            }
        }

        // Mostrar IDs no encontrados
        function mostrarIdsNoEncontrados(idsNoEncontrados) {
            if (idsNoEncontrados.length === 0) return;
            
            const container = document.createElement('div');
            container.style.cssText = `
                background: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                padding: 15px;
                margin-top: 20px;
            `;
            
            container.innerHTML = `
                <h4 style="color: #dc3545; margin: 0 0 10px 0;">
                    ‚ö†Ô∏è IDs No Encontrados (${idsNoEncontrados.length})
                </h4>
                <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; max-height: 100px; overflow-y: auto;">
                    ${idsNoEncontrados.join(', ')}
                </div>
            `;
            
            document.getElementById('resultsSection').appendChild(container);
        }

        // Mostrar registros no encontrados en b√∫squeda cascada
        function mostrarRegistrosNoEncontradosCascada(noEncontrados) {
            if (noEncontrados.length === 0) return;
            
            const container = document.createElement('div');
            container.style.cssText = `
                background: #fff3cd;
                border: 2px solid #ffeaa7;
                border-radius: 8px;
                padding: 20px;
                margin-top: 20px;
            `;
            
            let tablaNoEncontrados = `
                <h4 style="color: #856404; margin: 0 0 15px 0;">
                    ‚ùå Registros No Encontrados (${noEncontrados.length})
                </h4>
                <div style="max-height: 300px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="border: 1px solid #dee2e6; padding: 8px;">Fila</th>
                                <th style="border: 1px solid #dee2e6; padding: 8px;">ID</th>
                                <th style="border: 1px solid #dee2e6; padding: 8px;">Folio</th>
                                <th style="border: 1px solid #dee2e6; padding: 8px;">Referencia</th>
                                <th style="border: 1px solid #dee2e6; padding: 8px;">Autorizaci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            noEncontrados.forEach(registro => {
                const excel = registro.excelData;
                const intentos = registro.intentos;
                
                tablaNoEncontrados += `
                    <tr>
                        <td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">${registro.originalRow}</td>
                        <td style="border: 1px solid #dee2e6; padding: 8px; font-family: monospace;">${intentos.id}</td>
                        <td style="border: 1px solid #dee2e6; padding: 8px; font-family: monospace;">${intentos.folio}</td>
                        <td style="border: 1px solid #dee2e6; padding: 8px; font-family: monospace;">${intentos.referencia}</td>
                        <td style="border: 1px solid #dee2e6; padding: 8px; font-family: monospace;">${intentos.autorizacion}</td>
                    </tr>
                `;
            });
            
            tablaNoEncontrados += `
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 10px; color: #856404; font-size: 11px;">
                    üí° Estos registros se intentaron buscar por ID ‚Üí Folio ‚Üí Referencia ‚Üí Autorizaci√≥n sin √©xito.
                </div>
            `;
            
            container.innerHTML = tablaNoEncontrados;
            document.getElementById('resultsSection').appendChild(container);
        }

        // Limpiar formulario
        function clearForm() {
            searchForm.reset();
            resultsSection.style.display = 'none';
            ocultarError();
            toggleSearchMode(); // Restaurar modo single
        }

        // B√∫squeda en tiempo real (solo para modo individual)
        document.getElementById('searchId').addEventListener('input', (e) => {
            const searchType = document.getElementById('searchType').value;
            if (searchType === 'single' && e.target.value.length >= 3) {
                realizarBusqueda();
            }
        });

        // Contador de IDs en modo masivo
        document.getElementById('searchIds').addEventListener('input', (e) => {
            const text = e.target.value.trim();
            const ids = text.split(/[\n,\s]+/).filter(id => id.trim());
            const label = document.querySelector('label[for="searchIds"]');
            
            if (ids.length > 0) {
                label.textContent = `üìù IDs de Transacci√≥n M√∫ltiples (${ids.length} detectados):`;
            } else {
                label.textContent = 'üìù IDs de Transacci√≥n M√∫ltiples:';
            }
        });

        // Contador de autorizaciones en modo masivo
        document.getElementById('searchAuths').addEventListener('input', (e) => {
            const text = e.target.value.trim();
            const auths = text.split(/[\n,\s]+/).filter(auth => auth.trim());
            const label = document.querySelector('label[for="searchAuths"]');
            
            if (auths.length > 0) {
                label.textContent = `üîë Autorizaciones M√∫ltiples (${auths.length} detectadas):`;
            } else {
                label.textContent = 'üîë Autorizaciones M√∫ltiples:';
            }
        });

        // Contador y estad√≠sticas para modo cascada Excel
        document.getElementById('excelData').addEventListener('input', (e) => {
            const text = e.target.value.trim();
            
            if (!text) {
                document.getElementById('cascadaStats').style.display = 'none';
                return;
            }
            
            try {
                const rows = parseExcelData(text);
                
                if (rows.length === 0) {
                    document.getElementById('cascadaStats').style.display = 'none';
                    return;
                }
                
                // Calcular estad√≠sticas
                const stats = {
                    total: rows.length,
                    validIds: rows.filter(r => r.id && r.id.length > 0).length,
                    validFolios: rows.filter(r => r.folio && r.folio.length > 0).length,
                    validRefs: rows.filter(r => r.referencia && r.referencia.length > 0).length,
                    validAuths: rows.filter(r => r.autorizacion && r.autorizacion.length > 0).length
                };
                
                // Actualizar interfaz
                document.getElementById('totalRows').textContent = stats.total;
                document.getElementById('validIds').textContent = stats.validIds;
                document.getElementById('validFolios').textContent = stats.validFolios;
                document.getElementById('validAuths').textContent = stats.validAuths;
                
                document.getElementById('cascadaStats').style.display = 'block';
                
            } catch (error) {
                console.error('Error parseando Excel:', error);
                document.getElementById('cascadaStats').style.display = 'none';
            }
        });

        // Funci√≥n para exportar resultados a Excel
        function exportarResultados() {
            if (!window.ultimosResultados || window.ultimosResultados.length === 0) {
                alert('No hay resultados para exportar');
                return;
            }

            try {
                const isCascadaExcel = window.ultimaRespuesta && window.ultimaRespuesta.searchType === 'cascada_excel';
                
                // Headers diferentes para b√∫squeda en cascada
                let headers, csvRows;
                
                if (isCascadaExcel) {
                    headers = ['ENCONTRADO_CON', 'TIPO_BUSQUEDA', 'Fila_Excel', 'ID', 'ID_Transaccion', 'Autorizacion', 'Cliente', 'Sucursal', 'Monto', 'Fecha_Peticion', 'Comentarios', 'Excel_ID', 'Excel_Folio', 'Excel_Referencia', 'Excel_Auth'];
                    
                    csvRows = window.ultimosResultados.map(row => {
                        // Determinar qu√© valor se us√≥ para encontrarlo
                        let encontradoCon = '';
                        let tipoBusqueda = '';
                        
                        if (row.foundBy && row.foundWith) {
                            encontradoCon = row.foundWith;
                            tipoBusqueda = row.foundBy.toUpperCase();
                        }
                        
                        return [
                            `"${encontradoCon.replace(/"/g, '""')}"`,
                            tipoBusqueda,
                            row.originalRow || '',
                            row.id || '',
                            row.id_de_transaccion || '',
                            `"${(row.autorizacion || '').replace(/"/g, '""')}"`,
                            `"${(row.cliente || '').replace(/"/g, '""')}"`,
                            `"${(row.sucursal || '').replace(/"/g, '""')}"`,
                            row.monto || '',
                            row.fecha_de_peticion || '',
                            `"${(row.comentarios || '').replace(/"/g, '""')}"`,
                            `"${(row.excelData?.id || '').replace(/"/g, '""')}"`,
                            `"${(row.excelData?.folio || '').replace(/"/g, '""')}"`,
                            `"${(row.excelData?.referencia || '').replace(/"/g, '""')}"`,
                            `"${(row.excelData?.autorizacion || '').replace(/"/g, '""')}"`
                        ].join(',');
                    });
                    
                    // Agregar registros no encontrados si existen
                    if (window.ultimaRespuesta.notFound && window.ultimaRespuesta.notFound.length > 0) {
                        window.ultimaRespuesta.notFound.forEach(noEncontrado => {
                            csvRows.push([
                                'NO_ENCONTRADO',
                                'NINGUNO',
                                noEncontrado.originalRow || '',
                                '', '', '', '', '', '', '', '',
                                `"${(noEncontrado.excelData?.id || '').replace(/"/g, '""')}"`,
                                `"${(noEncontrado.excelData?.folio || '').replace(/"/g, '""')}"`,
                                `"${(noEncontrado.excelData?.referencia || '').replace(/"/g, '""')}"`,
                                `"${(noEncontrado.excelData?.autorizacion || '').replace(/"/g, '""')}"`
                            ].join(','));
                        });
                    }
                } else {
                    headers = ['ID', 'ID_Transaccion', 'Autorizacion', 'Cliente', 'Sucursal', 'Monto', 'Monto_MXN', 'Fecha_Peticion', 'Comentarios', 'Procesador', 'Bloque', 'Estado'];
                    
                    csvRows = window.ultimosResultados.map(row => [
                        row.id || '',
                        row.id_de_transaccion || '',
                        `"${(row.autorizacion || '').replace(/"/g, '""')}"`,
                        `"${(row.cliente || '').replace(/"/g, '""')}"`,
                        `"${(row.sucursal || '').replace(/"/g, '""')}"`,
                        row.monto || '',
                        row.monto_mnx || '',
                        row.fecha_de_peticion || '',
                        `"${(row.comentarios || '').replace(/"/g, '""')}"`,
                        `"${(row.procesador || '').replace(/"/g, '""')}"`,
                        `"${(row.bloque || '').replace(/"/g, '""')}"`,
                        `"${(row.captura_cc || '').replace(/"/g, '""')}"`
                    ].join(','));
                }
                
                const csvContent = [headers.join(','), ...csvRows].join('\n');

                // Crear y descargar archivo
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                const fileName = isCascadaExcel ? 
                    `aclaraciones_cascada_${new Date().toISOString().split('T')[0]}.csv` :
                    `aclaraciones_${new Date().toISOString().split('T')[0]}.csv`;
                
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                const totalRecords = isCascadaExcel ? 
                    (window.ultimosResultados.length + (window.ultimaRespuesta.notFound?.length || 0)) :
                    window.ultimosResultados.length;
                
                console.log(`üìä Exportados ${totalRecords} registros a Excel (${isCascadaExcel ? 'Cascada' : 'Normal'})`);
                
            } catch (error) {
                console.error('Error exportando:', error);
                alert('Error al exportar los datos');
            }
        }

        console.log('‚úÖ P√°gina de b√∫squeda de aclaraciones cargada correctamente');
    </script>
</body>
</html>