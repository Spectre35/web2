<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Debug OCR Completo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #1a1a1a;
            color: white;
            max-width: 1200px;
            margin: 0 auto;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .section {
            background: #333;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #555;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        input[type="file"] {
            background: #555;
            color: white;
            padding: 10px;
            border: 1px solid #777;
            border-radius: 4px;
            width: 100%;
            margin-bottom: 10px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #555; cursor: not-allowed; }
        .log-container {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            height: 300px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.4;
        }
        .progress {
            background: #444;
            border-radius: 8px;
            padding: 4px;
            margin: 10px 0;
        }
        .progress-bar {
            background: linear-gradient(90deg, #28a745, #20c997);
            height: 20px;
            border-radius: 4px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        .result-box {
            background: #2d3748;
            border: 1px solid #4a5568;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .field-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
            margin: 10px 0;
        }
        .field-label {
            color: #cbd5e0;
            font-weight: bold;
        }
        .field-value {
            background: #1a202c;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #4a5568;
        }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .info { color: #74c0fc; }
        .debug { color: #ffd43b; }
    </style>
</head>
<body>
    <h1>üîç Test Debug OCR Completo</h1>
    
    <div class="container">
        <!-- Secci√≥n de upload -->
        <div class="section">
            <h2>üì§ Subir Documento</h2>
            <input type="file" id="fileInput" accept="image/*,.pdf" />
            <div>
                <label>Sucursal: </label>
                <input type="text" id="sucursal" value="TEST" style="width: 100px;">
            </div>
            <div>
                <label>Bloque: </label>
                <input type="text" id="bloque" value="1" style="width: 100px;">
            </div>
            <div>
                <label>Caja: </label>
                <input type="text" id="caja" value="1" style="width: 100px;">
            </div>
            <button onclick="uploadFile()" id="uploadBtn">üöÄ Procesar Documento</button>
            
            <!-- Progress Bars -->
            <div id="uploadProgress" class="progress" style="display: none;">
                <div class="progress-bar" id="uploadProgressBar">Subiendo...</div>
            </div>
            <div id="processProgress" class="progress" style="display: none;">
                <div class="progress-bar" id="processProgressBar">Procesando...</div>
            </div>
            <div id="status"></div>
        </div>
        
        <!-- Logs del servidor -->
        <div class="section">
            <h2>üìã Logs del Servidor</h2>
            <button onclick="fetchLogs()">üîÑ Actualizar Logs</button>
            <button onclick="clearLogs()">üóëÔ∏è Limpiar Logs</button>
            <div id="serverLogs" class="log-container"></div>
        </div>
        
        <!-- Resultados del OCR -->
        <div class="section full-width">
            <h2>üìÑ Resultados del OCR</h2>
            <div id="ocrResults"></div>
        </div>
        
        <!-- Debug Info -->
        <div class="section full-width" id="debugSection" style="display: none;">
            <h2>üîç Informaci√≥n de Debug</h2>
            <div id="debugInfo"></div>
        </div>
    </div>

    <script>
        let currentBatchId = null;
        let pollingInterval = null;

        // Generar batchId √∫nico
        function generateBatchId() {
            return (typeof crypto !== 'undefined' && crypto.randomUUID) 
                ? crypto.randomUUID() 
                : `batch_${Date.now()}_${Math.floor(Math.random()*10000)}`;
        }

        // Subir archivo
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Por favor selecciona un archivo');
                return;
            }

            currentBatchId = generateBatchId();
            console.log(`üöÄ Iniciando procesamiento con batchId: ${currentBatchId}`);

            const formData = new FormData();
            formData.append('file', file);
            formData.append('batchId', currentBatchId);
            formData.append('sucursal', document.getElementById('sucursal').value);
            formData.append('bloque', document.getElementById('bloque').value);
            formData.append('caja', document.getElementById('caja').value);

            // UI Updates
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('uploadProgress').style.display = 'block';
            document.getElementById('processProgress').style.display = 'block';
            document.getElementById('status').innerHTML = '<span class="info">üì§ Subiendo archivo...</span>';

            // Start progress polling
            startProgressPolling();

            try {
                const response = await fetch('http://localhost:3001/api/ocr/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('status').innerHTML = '<span class="success">‚úÖ Procesamiento completado</span>';
                    displayResults(result);
                    if (result.debugInfo) {
                        displayDebugInfo(result.debugInfo);
                    }
                } else {
                    document.getElementById('status').innerHTML = `<span class="error">‚ùå Error: ${result.error}</span>`;
                }
            } catch (error) {
                document.getElementById('status').innerHTML = `<span class="error">‚ùå Error de conexi√≥n: ${error.message}</span>`;
                console.error('Error:', error);
            } finally {
                stopProgressPolling();
                document.getElementById('uploadBtn').disabled = false;
            }
        }

        // Polling de progreso
        function startProgressPolling() {
            if (pollingInterval) clearInterval(pollingInterval);
            
            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`http://localhost:3001/api/ocr/processing-progress?batchId=${currentBatchId}`);
                    const data = await response.json();
                    
                    if (data.success && data.progress) {
                        const progress = data.progress;
                        const percent = progress.total > 0 ? Math.round((progress.processed / progress.total) * 100) : 0;
                        
                        updateProgressBar('processProgressBar', percent, `${progress.filename || 'Procesando'} - ${progress.processed}/${progress.total}`);
                        
                        if (progress.processed >= progress.total) {
                            stopProgressPolling();
                        }
                    }
                } catch (err) {
                    console.log('Polling error (normal):', err.message);
                }
            }, 500);
        }

        function stopProgressPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }

        function updateProgressBar(barId, percent, text) {
            const bar = document.getElementById(barId);
            bar.style.width = percent + '%';
            bar.textContent = text || `${percent}%`;
        }

        // Mostrar resultados
        function displayResults(result) {
            const container = document.getElementById('ocrResults');
            const results = result.results || result.validationData || [];
            
            if (!results || results.length === 0) {
                container.innerHTML = '<div class="error">‚ùå No se obtuvieron resultados</div>';
                return;
            }

            let html = '';
            results.forEach((item, index) => {
                html += `
                    <div class="result-box">
                        <h3>üìÑ Documento ${index + 1}</h3>
                        <div class="field-grid">
                            <span class="field-label">Archivo:</span>
                            <span class="field-value">${item.originalFileName || 'N/A'}</span>
                            
                            <span class="field-label">Cliente:</span>
                            <span class="field-value">${item.cliente || 'N/A'}</span>
                            
                            <span class="field-label">Monto:</span>
                            <span class="field-value">${item.monto || 'N/A'}</span>
                            
                            <span class="field-label">Folio:</span>
                            <span class="field-value">${item.folio || 'N/A'}</span>
                            
                            <span class="field-label">Fecha:</span>
                            <span class="field-value">${item.fecha_contrato || 'N/A'}</span>
                            
                            <span class="field-label">Tipo Pago:</span>
                            <span class="field-value">${item.t_pago || 'N/A'}</span>
                            
                            <span class="field-label">Confianza:</span>
                            <span class="field-value">${item.confidence || 'N/A'}%</span>
                            
                            <span class="field-label">Texto (primeros 200 chars):</span>
                            <span class="field-value">${(item.text || '').substring(0, 200)}...</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Mostrar info de debug
        function displayDebugInfo(debugInfo) {
            const section = document.getElementById('debugSection');
            const container = document.getElementById('debugInfo');
            
            let html = `
                <div class="result-box">
                    <h3>üîç Debug Information</h3>
                    <div class="field-grid">
                        <span class="field-label">Texto Original:</span>
                        <span class="field-value">${debugInfo.originalText ? debugInfo.originalText.substring(0, 300) + '...' : 'N/A'}</span>
                        
                        <span class="field-label">Confianza OCR:</span>
                        <span class="field-value">${debugInfo.ocrConfidence || 'N/A'}</span>
                        
                        <span class="field-label">Longitud Texto:</span>
                        <span class="field-value">${debugInfo.textLength || 'N/A'} caracteres</span>
                        
                        <span class="field-label">Tipo Documento:</span>
                        <span class="field-value">${debugInfo.documentType || 'N/A'}</span>
                        
                        <span class="field-label">Confianza Clasificaci√≥n:</span>
                        <span class="field-value">${debugInfo.classificationConfidence || 'N/A'}</span>
                    </div>
                    
                    <h4>üîÑ Pasos de Procesamiento:</h4>
                    <ul>
                        ${(debugInfo.processingSteps || []).map(step => `<li>${step}</li>`).join('')}
                    </ul>
                    
                    <h4>üìù Campos Extra√≠dos:</h4>
                    <pre style="background: #000; padding: 10px; border-radius: 4px; overflow-x: auto;">
${JSON.stringify(debugInfo.extractedFields || {}, null, 2)}
                    </pre>
                </div>
            `;
            
            container.innerHTML = html;
            section.style.display = 'block';
        }

        // Obtener logs del servidor
        async function fetchLogs() {
            try {
                const response = await fetch('http://localhost:3001/api/ocr/debug/logs');
                const data = await response.json();
                
                if (data.success) {
                    const logsContainer = document.getElementById('serverLogs');
                    let html = '';
                    
                    data.logs.reverse().forEach(log => {
                        const time = new Date(log.timestamp).toLocaleTimeString();
                        const className = log.type || 'info';
                        html += `<div class="${className}">[${time}] ${log.message}</div>`;
                    });
                    
                    logsContainer.innerHTML = html || '<div class="info">No hay logs disponibles</div>';
                }
            } catch (error) {
                document.getElementById('serverLogs').innerHTML = `<div class="error">Error cargando logs: ${error.message}</div>`;
            }
        }

        // Limpiar logs
        async function clearLogs() {
            try {
                await fetch('http://localhost:3001/api/ocr/debug/logs/clear', { method: 'POST' });
                fetchLogs();
            } catch (error) {
                console.error('Error limpiando logs:', error);
            }
        }

        // Auto-refresh logs cada 3 segundos
        setInterval(fetchLogs, 3000);

        // Cargar logs al inicio
        fetchLogs();
    </script>
</body>
</html>